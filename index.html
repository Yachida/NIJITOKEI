<!DOCTYPE html>
<html lang="ja-JP">
<head>
	<meta charset="UTF-8">
	<title>T</title>
	<link rel="stylesheet" type="text/css" href="http://yui.yahooapis.com/3.17.2/build/cssreset/cssreset-min.css">
	<link rel='stylesheet' type='text/css' href='http://fonts.googleapis.com/css?family=Oswald'>
	<link rel="stylesheet" type="text/css" href="style.css">
	<script src="//code.jquery.com/jquery-1.11.1.min.js"></script>
</head>
<body>
	<div id="canvasFrame" class="fadeout">
		<canvas id="mycanvas" width="200" height="100">
			Canvasに対応したブラウザを使ってください。
		</canvas>
	</div>
	<script src="./lib.js"></script>
	<script>
	var conf;
	window.onload = function() {
		$.get("app.json", function(data){
			conf = data;
			draw();
			$('#canvasFrame').addClass("fadein").removeClass("fadeout");
		});
	}
	function draw() {
		var canvas = document.getElementById('mycanvas');
		
		console.log(conf);
		
		var imgArray = getArray(conf.count);
				
		$('#canvasFrame').width(window.innerWidth);
		$('#canvasFrame').height(window.innerHeight);
		
		canvas.style.left = '150px';
		canvas.style.top = '500px';
		
		if (!canvas || !canvas.getContext('2d')) { return false; }
		var ctx = canvas.getContext('2d');
		
		var minit='';
		(function loop() {
		var time = new Date();
		
		if(time.getSeconds() === 59){
			$('#canvasFrame').addClass("fadeout").removeClass("fadein");
		}
		if(time.getSeconds() === 0){
			$('#canvasFrame').addClass("fadein").removeClass("fadeout");
		}
		
		if(time.getMinutes()!==minit){
			minit = time.getMinutes();
			
			if(!imgArray.length){
				imgArray = getArray(conf.count);
			}
			var num = getRandom(imgArray.length);
			var prof;
			$.get(imgArray[num]+".json", function(data){
				prof = data;
				console.log(prof);
				$('#canvasFrame').css('background-image', 'url(' + prof.file + ')');
				// 座標は割合で返すメソッドを用意する。
				canvas.style.left = ($('#canvasFrame').width() / 2) + prof.left + 'px';
				canvas.style.top = ($('#canvasFrame').height() / 2) + prof.top + 'px';
				canvas.width = prof.width;
				canvas.height = prof.height;
				console.log(canvas);
			});
			imgArray.splice(num,1)

		}
		
				
			ctx.font = ((canvas.width + canvas.height) / 6) + 'px Oswald';
			ctx.fillStyle = 'black';
			ctx.shadowColor = 'white';
			ctx.shadowOffsetX = 1;
			ctx.shadowOffsetY = 1;

			ctx.clearRect(0,0,canvas.width,canvas.height);
			
			var text = padZero(time.getHours())+':'+padZero(time.getMinutes())+':'+padZero(time.getSeconds());

			ctx.fillText(text, canvas.width/16,canvas.height - canvas.height/4);
			setTimeout(loop, 200);
		})();
		
	}
	</script>

</body>
</html>